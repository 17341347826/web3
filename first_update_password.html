<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="renderer" content="webkit">
    <meta name="baidu-site-verification" content="pwZcyU5Ols" />
    <title>眉山市初中学生综合素质评价</title>
    <!--<link href="//cdn.bootcss.com/amazeui/2.7.2/css/amazeui.css" rel="stylesheet">-->
    <link href="common/lib/amazeui.css" rel="stylesheet">
    <link rel="stylesheet" href="common/lib/amazeui.datetimepicker.css">
    <script src="common/lib/head_statistics.js"></script>
    <!--[if lt IE 9]>
    <script src="js/lib/modernizr.js"></script>
    <script src="js/lib/amazeui.ie8polyfill.js"></script>
    <![endif]-->
    <style>
        #first_update_password>.update_title{
            line-height: 80px;
            /*color:#40acc1;*/
            /*font-size: 18px;*/
            color: #5fc8b9;
            font-size: 24px;
            text-align: center;
            border-bottom: 1px #e4e4e4 solid;
        }
        #first_update_password>.update_content{
            width: 360px;
            margin: 40px auto;
        }
        #first_update_password>.update_content input{
            width: 360px;
            height: 50px;
            text-align: center;
            font-size: 18px;
            color:#afafaf;
            border-radius: 5px;
        }
        #first_update_password>.update_content input+div{
            margin: 0;
            padding-top: 20px;
            color:#f0685a;

        }
        /*取消、提交按钮开始-----参考页面：a-k-perform*/
        #first_update_password .btns button{
            width: 112px;
            height: 34px;
            border-radius: 4px 4px 4px 4px;
            font-size: 16px;
            color: #ffffff;
            outline:none;
            border:none;
        }
        #first_update_password .btns .am-btn-default{
            background-color: rgba(255, 170, 69, 1);
            border-color: rgba(255, 170, 69, 1);
            margin-right:25px;
        }
        #first_update_password .btns .am-btn-primary{
            background-color: rgba(50, 217, 156, 1);
            border-color: rgba(50, 217, 156, 1);
        }
        #first_update_password .btns .am-btn-default:hover{
            background-color: rgba(255, 122, 69, 1);
            color:#fff;
        }
        #first_update_password .btns .am-btn-primary:hover{
            background-color: rgba(43, 187, 124, 1);
            color:#fff;
        }
        #first_update_password .btns .am-btn-default:active,.btns .am-btn-primary:active{
            color:#fff;
        }
        /*取消、提交按钮结束*/
        /*用户名提示语*/
        #first_update_password .username_tips{
            color:red;
            font-size:14px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
<!--<div class="am-g" id="first_update_password" ms-controller="first_update_password">-->
    <!--<div  style="width: 70%;margin-left: 15%;margin-top: 10%;">-->
        <!--<form class="am-form am-form-horizontal" ms-validate="@validate">-->
            <!--<div class="am-form-group">-->
                <!--<label class="am-u-sm-2 am-form-label" for="doc-ipt-3">-->
                    <!--旧密码-->
                <!--</label>-->
                <!--<div class="am-u-sm-10">-->
                    <!--<input id="doc-ipt-3" ms-duplex="old_pwd" placeholder="输入你的旧密码" type="password"/>-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="am-form-group">-->
                <!--<label class="am-u-sm-2 am-form-label" for="doc-ipt-pwd-2">-->
                    <!--新密码-->
                <!--</label>-->
                <!--<div class="am-u-sm-10">-->
                    <!--<input id="doc-ipt-pwd-2" ms-duplex="new_pwd" ms-focus="@msgNull()" placeholder="请注意:密码长度为6-16位(不包括特殊字符)" type="password"/>-->
                    <!--<span :css="@span_css" :if="@span_num==1">-->
      <!--请注意:密码长度为6-16位字符串(不包括特殊字符)-->
     <!--</span>-->
                    <!--<span :css="@span_css" :if="@span_num==3">-->
      <!--请注意:与旧密码相同-->
     <!--</span>-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="am-form-group">-->
                <!--<label class="am-u-sm-2 am-form-label" for="doc-ipt-pwd-3">-->
                    <!--确认新密码-->
                <!--</label>-->
                <!--<div class="am-u-sm-10">-->
                    <!--<input id="doc-ipt-pwd-3" ms-duplex="sure_new_pwd" ms-focus="@msgNull()" placeholder="确认你的新密码" type="password"/>-->
                    <!--<span :css="@span_css" :if="@span_num==2">-->
      <!--请注意:两次输入的密码不一致-->
     <!--</span>-->
                <!--</div>-->
            <!--</div>-->
            <!--<div class="am-text-center" id="submitBtnDiv">-->
                <!--<a class="am-btn am-btn-default" ms-click="@cancel_click">-->
                    <!--取消-->
                <!--</a>-->
                <!--<a class="am-btn am-btn-primary am-margin-left-lg" ms-click="@save_click">-->
                    <!--保存-->
                <!--</a>-->
            <!--</div>-->
        <!--</form>-->
    <!--</div>-->
<!--</div>-->
<div class="am-g" id="first_update_password" ms-controller="first_update_password">
    <div class="update_title">
        <span>
            <!--<img src="../../../common/images/update_pwd.png" alt="">-->
            欢迎进入眉山市初中学生综合素质评价系统
        </span>
    </div>
    <div class="update_content">
        <form class="am-form am-form-horizontal" ms-validate="@validate">
            <!--用户名-->
            <div class="am-form-group" :visible="@username_show == 0">
                <div>
                    <input id="username" ms-duplex="user_name" ms-on-blur="@username_blur()"
                           ms-focus="@msgNull()" placeholder="请设置自定义用户名" type="text"/>
                    <div  :if="@username_msg != ''">{{@username_msg}}</div>
                </div>
                <div class="username_tips">提示：设置后不可更改，可用于登录，中英文均可，6-16个字符</div>
            </div>
            <!--旧密码-->
            <div class="am-form-group">
                <div>
                    <input ms-duplex="old_pwd" placeholder="请输入您的旧密码" type="password" disabled/>
                </div>
            </div>
            <!--新密码-->
            <div class="am-form-group">
                <div>
                    <input ms-duplex="@new_pwd" ms-focus="@msgNull()"
                           placeholder="请输入新密码(6-16位字母+数字组合)" type="password"/>
                    <div  :if="@span_num==1">请注意:8-16位且包含大写、小写、数字、特殊字符至少3种</div>
                    <div  :if="@span_num==3">请注意:与旧密码相同</div>
                </div>
            </div>
            <!--确认密码-->
            <div class="am-form-group">
                <div>
                    <input ms-duplex="@sure_new_pwd" ms-focus="@msgNull()" placeholder="请确认新密码"
                           type="password"/>
                    <div :if="@span_num==2">请注意:两次输入的密码不一致</div>
                </div>
            </div>
        </form>
        <div class="btns am-text-center">
            <button type="button" class="am-btn am-btn-default" ms-click="@cancel_click">取消</button>
            <button type="button" class="am-btn-primary" ms-click="@save_click()">保存</button>
        </div>
    </div>
</div>


<script src="common/lib/jquery.min.js"></script>
<script src="common/lib/amazeui.js"></script>
<script src="common/lib/avalon.js"></script>
<script src="const.js"></script>
<script src="common/module/request.js"></script>
<script src="common/lib/bin/jsencrypt.js"></script>
<script src="common/lib/rsa_public_key.js"></script>
<!--<script src="//cdn.bootcss.com/layer/3.0/layer.min.js"></script>-->
<script src="common/lib/layer.min.js"></script>
<script>
    avalon.ready(function() {
        var HTTP_X = location.origin;
        //设置用户名
        var api_defn_username = api.user+'baseUser/upd_u_defn_name';
        //修改密码
        var api_update_password=HTTP_X+"/api/base/baseUser/updpwd";
        //登陆成功信息设置
        var api_upd_login = HTTP_X+'/api/base/baseUser/upd_login';
        //承诺书是否签字
        var api_get_query_is_read = HTTP_X+ "/api/GrowthRecordBag/login_query_goodFaithCommitment";
        var vm = avalon.define({
            $id: "first_update_password",
            //密码设置提示错误
            span_num:0,
//            用户名输入是否显示:0-未设置；1-已设置
            username_show:1,
            //用户名错误提示
            username_msg:'',
//            span_css:{color:'red'},
            //用户名
            user_name:'',
            sure_new_pwd:"",
            old_pwd:"",
            new_pwd:"",
            //鼠标获得焦点清除错误
            msgNull:function () {
                this.span_num=0;
//                this.username_msg = '';
            },
            //用户名失去焦点
            username_blur:function(){
                this.username_msg = '';
                var txt = $('#username').val().trim();
                console.log(txt.length);
//                 if((txt.length<6 || txt.length>16) && txt != ''){
//                     this.username_msg = '用户名长度限制为6~16个字符';
// //                    return;
//                 }
                var reg=new RegExp(/^[\u4E00-\u9FA5\w]{6,16}$/i);
                var result = txt.replace(/[\u4E00-\u9FA5]/g,"aa");
                // alert(reg.test(result));
                if(!reg.test(result)){
                    this.username_msg = '用户名长度限制为6~16个字符';
                }
            },
//            保存
            save_click:function () {
//                用户名填写，但是字符长度不在6-16内
                if(this.username_msg != '')
                    return;
//                密码设置判断
//                var reg=/^\w{6,16}$/;
//                 var reg = /(?=^.*?\d)(?=^.*?[a-zA-Z])^[0-9a-zA-Z]{6,16}$/;
                var reg = /^(?![a-zA-Z]+$)(?![A-Z0-9]+$)(?![A-Z\\W_!@#$%^&*`~()-+=]+$)(?![a-z0-9]+$)(?![a-z\\W_!@#$%^&*`~()-+=]+$)(?![0-9\\W_!@#$%^&*`~()-+=]+$)[a-zA-Z0-9\\W_!@#$%^&*`~()-+=]{8,20}$/;
                if(reg.test(this.new_pwd)){
                    if(this.new_pwd!=this.sure_new_pwd){
                        this.span_num=2;
                        return;
                    }
                    this.span_num=0;
                    var publicKey=public_key;
                    var encrypt = new JSEncrypt(); // 实例化加密对象
                    encrypt.setPublicKey(publicKey); // 设置公钥
                    if(this.new_pwd==this.old_pwd){
                        this.span_num=3;
                        return;
                    }
                    var get_new_pwd=encrypt.encrypt(this.new_pwd);
                    var get_old_pwd=encrypt.encrypt(this.old_pwd);
//                    ajax_post(api_update_password,{new_pwd:get_new_pwd,old_pwd:get_old_pwd},this);
                    ajax_post(api_upd_login,{pwd:get_new_pwd,u_defn_name:this.user_name},this);
                }else{
                    this.span_num=1;
                }
            },
            on_request_complete: function(cmd, status, data, is_suc, msg) {
                if (is_suc) {
                    switch (cmd) {
//                        case api_update_password:
//                            this.complete_update_password(data);
//                            break;
//                        // 用户名设置
//                        case api_defn_username:
//                            layer.msg("用户名设置成功！");
//                            //承诺书是否签字
//                            ajax_post(api_get_query_is_read,{},this);
//                            break;
                        //登陆成功信息设置
                        case api_upd_login:
                            this.complete_upd_login(data);
                            break;
                        //承诺书是否签字
                        case api_get_query_is_read:
                            this.complete_get_query_is_read(data);
                            break;
                    }
                } else {
                    if(cmd !=  api_get_query_is_read){
                        layer.msg(msg);
                    }else{
                        this.complete_get_query_is_read(data);
                    }

                }
            },
//            complete_update_password:function (data) {
//                layer.msg("修改密码成功");
//                //用户名判断
//                if(this.user_name != ''){
//                    ajax_post(api_defn_username,{u_defn_name:this.user_name},this);
//                    return;
//                }
//                //承诺书是否签字
//                ajax_post(api_get_query_is_read,{},this);
//            },
            //登陆成功信息设置
            complete_upd_login:function(data){
               layer.msg('设置成功！');
                //承诺书是否签字
                ajax_post(api_get_query_is_read,{status:2},this);
            },
            complete_get_query_is_read:function (data) {
                if (data.data == true) {
                    window.location = HTTP_X + '/Growth/index.html';
                } else {
                    //根据鲜总要求暂时屏蔽
                    window.location = HTTP_X + '/Growth/index.html';
                    // window.location = HTTP_X + '/Growth/promise.html';
                }
            },
            cancel_click:function () {
                window.location=HTTP_X+"/Growth/new_index.html";
            }

        });
        vm.$watch('onReady', function() {
            var old =   sessionStorage.getItem("old_pwd");
            vm.old_pwd= old;
            //username_show:0-未设置；1-已设置
            vm.username_show = sessionStorage.getItem('username_show');
        })
        avalon.scan(document.body);
    })
</script>
</body>

</html>